<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>免分心搜索启动器</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
      crossorigin
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <style>
      :root {
        font-family: "Inter", "PingFang SC", "Microsoft YaHei", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      body {
        min-height: 100vh;
        background: #f5f5f7;
        color: #1d1d1f;
      }
      .fade-in {
        animation: fadeIn 0.8s ease forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .glass-shell {
        background: rgba(255, 255, 255, 0.72);
        border-radius: 28px;
        border: 1.5px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 25px 60px rgba(13, 23, 47, 0.12), 0 5px 18px rgba(15, 23, 42, 0.06);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
      }
      .glass-button {
        background: rgba(255, 255, 255, 0.58);
        border: 2px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05), 0 2px 6px rgba(0, 0, 0, 0.04);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        position: relative;
        overflow: hidden;
      }
      .glass-button::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(0, 122, 255, 0.08), transparent 65%);
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .glass-button:hover::before {
        opacity: 1;
      }
      .glass-button:hover {
        border-color: rgba(0, 122, 255, 0.6);
        box-shadow: 0 12px 30px rgba(0, 122, 255, 0.12), 0 2px 6px rgba(0, 0, 0, 0.04);
        color: #007aff;
      }
      .glass-button:active {
        transform: scale(0.985);
      }
      .platform-selector {
        position: relative;
      }
      #platformSelector {
        transition: all 0.2s ease;
      }
      #platformSelector:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .platform-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transform: translateY(-10px);
        transition: all 0.2s ease;
      }
      .platform-dropdown.show {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
      }
      .platform-option {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: background 0.2s;
      }
      .platform-option:hover {
        background: #f5f5f7;
      }
      .platform-option.selected {
        background: #f0f9ff;
        color: #007aff;
      }
      .history-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 200;
        display: flex;
        align-items: flex-end;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      .history-panel.show {
        opacity: 1;
        pointer-events: auto;
      }
      .history-content {
        background: white;
        border-radius: 24px 24px 0 0;
        width: 100%;
        max-height: 70vh;
        padding: 24px;
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }
      .history-panel.show .history-content {
        transform: translateY(0);
      }
      .history-item {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
        border-left: 4px solid transparent;
      }
      .history-item:hover {
        background: #f5f5f7;
        transform: translateX(4px);
      }
      .app-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
      }
      .app-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .platform-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .platform-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
    </style>
  </head>
  <body class="flex items-center justify-center px-4 py-12">
    <main
      class="glass-shell w-full max-w-[615px] px-8 py-10 space-y-10 fade-in"
    >
      <header class="space-y-4 text-center text-[#1D1D1F]">
        <p class="text-xs tracking-[0.35em] uppercase text-[#86868B]">Focus Mode</p>
        <h1 class="text-[36px] font-semibold tracking-[0.06em]">FOCUS MODE</h1>
        <p class="text-[#86868B] text-sm">
          输入关键词，直达目标平台搜索结果。保持专注，不被信息流打扰。
        </p>
      </header>

      <section class="space-y-4">
        <label for="keyword" class="text-sm font-medium text-[#1D1D1F]"
          >搜索关键词</label
        >
        <div class="relative">
          <input
            id="keyword"
            type="text"
            placeholder="请输入搜索的主题/关键词"
            class="w-full rounded-[12px] border-2 border-[#E5E5EA] bg-white px-5 py-5 text-lg text-[#1D1D1F] placeholder-[#86868B] transition shadow-sm focus:border-[#007AFF] focus:shadow-[0_0_0_4px_rgba(0,122,255,0.12)] focus:outline-none"
          />
          <button
            id="clearInput"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-[#86868B] hover:text-[#007AFF] transition text-xl"
            aria-label="清除输入"
          >
            ✕
          </button>
        </div>
        <div class="flex items-center gap-3 mt-2">
          <div class="platform-selector flex-1">
            <button
              id="platformSelector"
              class="w-full rounded-lg px-4 py-3 flex items-center gap-2 text-white font-medium transition"
              style="background-color: #0084FF;"
            >
              <span id="selectedPlatformIcon" class="platform-icon">
                <img id="selectedPlatformIconImg" src="" alt="" />
              </span>
              <span id="selectedPlatformLabel" class="flex-1 text-left">知乎</span>
              <span class="text-xs">▼</span>
            </button>
            <div id="platformDropdown" class="platform-dropdown">
              <!-- 平台选项将通过JS动态生成 -->
            </div>
          </div>
          <button
            id="historyBtn"
            class="px-4 py-3 bg-gray-100 rounded-lg text-sm text-[#1D1D1F] hover:bg-gray-200 transition"
          >
            历史记录
          </button>
          <button
            id="searchBtn"
            class="px-6 py-3 bg-gray-800 rounded-lg text-white font-medium hover:bg-gray-700 transition flex items-center gap-2"
          >
            搜索
            <span>→</span>
          </button>
        </div>
      </section>

      <section aria-label="搜索平台" class="space-y-4">
        <div class="flex items-center justify-between text-[#86868B] text-xs uppercase tracking-[0.3em]">
          <span>快速跳转</span>
          <span>新标签页打开</span>
        </div>
        <div id="platformGrid" class="grid grid-cols-2 gap-4"></div>
      </section>

      <footer class="text-center text-sm text-[#86868B]">
        打开浏览器设置，<span class="text-[#007AFF] font-semibold">添加到桌面</span>
        <div class="mt-1">支持移动端 & 桌面端</div>
      </footer>
    </main>

    <div
      id="toast"
      class="fixed left-1/2 -translate-x-1/2 bottom-6 bg-white border border-white/80 text-[#1D1D1F] px-4 py-3 rounded-2xl text-sm shadow-[0_10px_30px_rgba(15,23,42,0.12)] backdrop-blur-md opacity-0 pointer-events-none transition"
      role="status"
      aria-live="polite"
    ></div>

    <div id="historyPanel" class="history-panel">
      <div class="history-content">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-[#1D1D1F]">搜索历史</h3>
          <div class="flex gap-2">
            <button
              id="clearHistory"
              class="text-sm text-[#86868B] hover:text-[#007AFF] transition"
            >
              清空
            </button>
            <button
              id="closeHistory"
              class="text-xl text-[#86868B] hover:text-[#1D1D1F] transition"
            >
              ✕
            </button>
          </div>
        </div>
        <div id="historyList" class="space-y-2">
          <!-- 历史记录项将通过JS动态生成 -->
        </div>
        <div id="emptyHistory" class="text-center text-[#86868B] py-8 text-sm hidden">
          暂无搜索历史
        </div>
      </div>
    </div>

    <script>
      const DEFAULT_PLATFORM = "zhihu";
      const isMobileDevice = /Android|iPhone|iPad|iPod|Mobile/i.test(
        navigator.userAgent
      );
      const platforms = [
        {
          id: "zhihu",
          label: "知乎",
          icon: "知乎 App - App Store.webp",
          brandColor: "#0084FF",
          url: (encoded) => `https://www.zhihu.com/search?type=content&q=${encoded}`,
          className: "",
        },
        {
          id: "xiaohongshu",
          label: "小红书",
          icon: "小红书 - App Store.webp",
          brandColor: "#FF2442",
          url: (encoded) =>
            `https://www.xiaohongshu.com/search_result?keyword=${encoded}&source=web_search`,
          mobileUrl: (encoded) =>
            `https://www.xiaohongshu.com/search_result?keyword=${encoded}&source=webapp`,
          deepLink: (encoded, raw) =>
            `xhsdiscover://search/result?keyword=${encodeURIComponent(raw)}`,
          className: "",
        },
        {
          id: "weibo",
          label: "微博",
          icon: "微博 - App Store.webp",
          brandColor: "#E6162D",
          url: (encoded) => `https://s.weibo.com/weibo?q=${encoded}`,
          className: "",
        },
        {
          id: "bilibili",
          label: "哔哩哔哩",
          icon: "哔哩哔哩-弹幕番剧直播高清视频 App - App Store.webp",
          brandColor: "#FB7299",
          url: (encoded) => `https://search.bilibili.com/all?keyword=${encoded}`,
          className: "",
        },
        {
          id: "taobao",
          label: "淘宝",
          icon: "淘宝.webp",
          brandColor: "#FF6A00",
          url: (encoded) => `https://s.taobao.com/search?q=${encoded}`,
          className: "",
        },
        {
          id: "pinduoduo",
          label: "拼多多",
          icon: "拼多多.webp",
          brandColor: "#E02E24",
          url: (encoded) =>
            `https://mobile.yangkeduo.com/search_result.html?search_key=${encoded}`,
          className: "",
        },
      ];

      // 当前选中的平台
      let currentPlatform = DEFAULT_PLATFORM;

      const keywordInput = document.getElementById("keyword");
      const clearBtn = document.getElementById("clearInput");
      const toast = document.getElementById("toast");
      const platformGrid = document.getElementById("platformGrid");
      const platformSelector = document.getElementById("platformSelector");
      const platformDropdown = document.getElementById("platformDropdown");
      const selectedPlatformIcon = document.getElementById("selectedPlatformIcon");
      const selectedPlatformLabel = document.getElementById("selectedPlatformLabel");
      const historyBtn = document.getElementById("historyBtn");
      const historyPanel = document.getElementById("historyPanel");
      const historyList = document.getElementById("historyList");
      const emptyHistory = document.getElementById("emptyHistory");
      const clearHistory = document.getElementById("clearHistory");
      const closeHistory = document.getElementById("closeHistory");
      const searchBtn = document.getElementById("searchBtn");

      // 历史记录管理
      function getHistory() {
        try {
          const history = localStorage.getItem("searchHistory");
          return history ? JSON.parse(history) : [];
        } catch (e) {
          return [];
        }
      }

      function saveHistory(query, platformId) {
        try {
          const history = getHistory();
          const newItem = {
            query,
            platformId,
            timestamp: Date.now(),
          };
          // 移除重复项
          const filtered = history.filter(
            (item) => !(item.query === query && item.platformId === platformId)
          );
          // 添加到开头
          filtered.unshift(newItem);
          // 最多保存50条
          const limited = filtered.slice(0, 50);
          localStorage.setItem("searchHistory", JSON.stringify(limited));
        } catch (e) {
          console.warn("Failed to save history", e);
        }
      }

      function renderHistory() {
        const history = getHistory();
        historyList.innerHTML = "";
        
        if (history.length === 0) {
          emptyHistory.classList.remove("hidden");
          return;
        }
        
        emptyHistory.classList.add("hidden");
        history.forEach((item) => {
          const platform = platforms.find((p) => p.id === item.platformId) || platforms[0];
          const div = document.createElement("div");
          div.className = "history-item";
          div.style.borderLeftColor = platform.brandColor;
          div.innerHTML = `
            <div class="flex items-center gap-2 flex-1">
              <span class="app-icon">
                <img src="${platform.icon}" alt="${platform.label}" />
              </span>
              <span class="text-sm text-[#1D1D1F]">${item.query}</span>
              <span class="text-xs text-[#86868B]">- ${platform.label}</span>
            </div>
            <button class="text-xs text-[#86868B] hover:text-red-500 transition" data-action="delete">删除</button>
          `;
          
          // 删除按钮
          const deleteBtn = div.querySelector('[data-action="delete"]');
          deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            deleteHistoryItem(item);
          });
          
          // 点击历史项（除了删除按钮）
          div.addEventListener("click", (e) => {
            if (e.target.dataset.action === "delete") {
              return;
            }
            keywordInput.value = item.query;
            currentPlatform = item.platformId;
            updatePlatformSelector();
            openSearch(item.platformId);
            closeHistoryPanel();
          });
          
          historyList.appendChild(div);
        });
      }

      function deleteHistoryItem(item) {
        try {
          const history = getHistory();
          const filtered = history.filter(
            (h) => !(h.query === item.query && h.platformId === item.platformId && h.timestamp === item.timestamp)
          );
          localStorage.setItem("searchHistory", JSON.stringify(filtered));
          renderHistory();
        } catch (e) {
          console.warn("Failed to delete history item", e);
        }
      }

      function clearAllHistory() {
        if (confirm("确定要清空所有搜索历史吗？")) {
          try {
            localStorage.removeItem("searchHistory");
            renderHistory();
            showToast("历史记录已清空");
          } catch (e) {
            console.warn("Failed to clear history", e);
          }
        }
      }

      function openHistoryPanel() {
        renderHistory();
        historyPanel.classList.add("show");
      }

      function closeHistoryPanel() {
        historyPanel.classList.remove("show");
      }

      function showToast(message) {
        toast.textContent = message;
        toast.classList.remove("opacity-0");
        toast.classList.add("opacity-100");
        toast.style.pointerEvents = "auto";
        clearTimeout(showToast.timer);
        showToast.timer = setTimeout(() => {
          toast.classList.add("opacity-0");
          toast.classList.remove("opacity-100");
          toast.style.pointerEvents = "none";
        }, 2200);
      }

      function getQuery() {
        return keywordInput.value.trim();
      }

      function closeKeyboard() {
        if (document.activeElement === keywordInput) {
          keywordInput.blur();
        }
        window.scrollTo({ top: 0, behavior: "auto" });
      }

      function handleVisibilityReturn() {
        if (!document.hidden) {
          closeKeyboard();
        }
      }

      document.addEventListener("visibilitychange", handleVisibilityReturn);
      window.addEventListener("pageshow", handleVisibilityReturn);

      function openNewTab(url) {
        window.open(url, "_blank", "noopener");
      }

      function invokeDeepLink(url) {
        if (!url) return;
        try {
          const iframe = document.createElement("iframe");
          iframe.style.display = "none";
          iframe.src = url;
          document.body.appendChild(iframe);
          setTimeout(() => {
            iframe.remove();
          }, 1500);
        } catch (error) {
          console.warn("Unable to trigger deep link", error);
        }
      }

      function updatePlatformSelector() {
        const platform = platforms.find((p) => p.id === currentPlatform) || platforms[0];
        const iconImg = document.getElementById("selectedPlatformIconImg");
        if (iconImg) {
          iconImg.src = platform.icon;
          iconImg.alt = platform.label;
        }
        selectedPlatformLabel.textContent = platform.label;
        // 更新按钮背景色为品牌色
        platformSelector.style.backgroundColor = platform.brandColor;
        platformSelector.style.borderColor = platform.brandColor;
      }

      function renderPlatformDropdown() {
        platformDropdown.innerHTML = "";
        platforms.forEach((platform) => {
          const option = document.createElement("div");
          option.className = `platform-option ${platform.id === currentPlatform ? "selected" : ""}`;
          if (platform.id === currentPlatform) {
            option.style.backgroundColor = `${platform.brandColor}15`;
            option.style.color = platform.brandColor;
          }
          option.innerHTML = `
            <span class="app-icon">
              <img src="${platform.icon}" alt="${platform.label}" />
            </span>
            <span class="flex-1">${platform.label}</span>
          `;
          option.addEventListener("click", () => {
            currentPlatform = platform.id;
            updatePlatformSelector();
            platformDropdown.classList.remove("show");
            renderPlatformDropdown(); // 重新渲染以更新选中状态
          });
          platformDropdown.appendChild(option);
        });
      }

      function togglePlatformDropdown() {
        platformDropdown.classList.toggle("show");
      }

      function openSearch(platformId) {
        const query = getQuery();
        if (!query) {
          showToast("请输入关键词再搜索");
          keywordInput.focus();
          return;
        }

        const platform = platforms.find((p) => p.id === platformId) || platforms[0];
        const encoded = encodeURIComponent(query);
        const fallbackUrl = platform.url(encoded, query);
        const mobileUrl =
          isMobileDevice && typeof platform.mobileUrl === "function"
            ? platform.mobileUrl(encoded, query)
            : null;
        const targetUrl = mobileUrl || fallbackUrl;

        // 保存历史记录
        saveHistory(query, platformId);

        closeKeyboard();

        if (isMobileDevice && typeof platform.deepLink === "function") {
          invokeDeepLink(platform.deepLink(encoded, query));
        }

        openNewTab(targetUrl);
      }

      function renderButtons() {
        const fragment = document.createDocumentFragment();
        platforms.forEach((platform) => {
          const button = document.createElement("button");
          button.type = "button";
          button.dataset.platform = platform.id;
          button.className = [
            "glass-button group w-full min-h-[90px] rounded-[16px] text-[17px] font-semibold tracking-[0.02em] flex items-center justify-center gap-3 text-[#1D1D1F] hover:text-[#007AFF] transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-[#007AFF]/60 focus-visible:ring-offset-2 focus-visible:ring-offset-transparent",
            platform.className,
          ]
            .filter(Boolean)
            .join(" ");
          button.innerHTML = `
            <span class="platform-icon">
              <img src="${platform.icon}" alt="${platform.label}" />
            </span>
            <span>${platform.label}</span>
          `;
          button.addEventListener("click", () => openSearch(platform.id));
          fragment.appendChild(button);
        });
        platformGrid.appendChild(fragment);
      }

      // 事件监听器
      keywordInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          openSearch(currentPlatform);
        }
      });

      clearBtn.addEventListener("click", () => {
        keywordInput.value = "";
        if (!isMobileDevice) {
          keywordInput.focus();
        }
      });

      platformSelector.addEventListener("click", (e) => {
        e.stopPropagation();
        togglePlatformDropdown();
      });

      // 点击外部关闭下拉菜单
      document.addEventListener("click", (e) => {
        if (!platformSelector.contains(e.target) && !platformDropdown.contains(e.target)) {
          platformDropdown.classList.remove("show");
        }
      });

      searchBtn.addEventListener("click", () => {
        openSearch(currentPlatform);
      });

      historyBtn.addEventListener("click", () => {
        openHistoryPanel();
      });

      closeHistory.addEventListener("click", () => {
        closeHistoryPanel();
      });

      clearHistory.addEventListener("click", () => {
        clearAllHistory();
      });

      // 点击历史面板背景关闭
      historyPanel.addEventListener("click", (e) => {
        if (e.target === historyPanel) {
          closeHistoryPanel();
        }
      });

      // 初始化
      updatePlatformSelector();
      renderPlatformDropdown();
      renderButtons();
    </script>
  </body>
</html>

